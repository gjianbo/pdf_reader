# 项目开发规则 (PDF Reader)

## 一、代码注释规范

### 1.1 文件头注释
每个源文件必须包含文件头注释，说明文件用途、作者、创建日期等信息。

```dart
/// 文件名称：reader_controller.dart
/// 功能描述：阅读器核心控制器，管理图书加载、翻页、TTS播放状态及阅读进度
/// 作者：开发团队
/// 创建日期：2025-01-01
/// 修改记录：
///   - 2025-01-01: 初始版本创建，支持PDF基础阅读
///   - 2025-01-10: 增加TTS语音朗读支持
library;
```

### 1.2 类注释
每个类必须有注释，说明类的功能、职责和使用场景。

```dart
/// 图书数据模型 (Isar Entity)
/// 
/// 映射本地数据库中的图书信息，包含元数据、阅读进度和缓存路径
/// 
/// 使用示例：
/// ```dart
/// final book = Book()
///   ..title = "三体"
///   ..path = "/storage/emulated/0/Download/three_body.pdf"
///   ..lastReadPosition = 12;
/// await isar.writeTxn(() async {
///   await isar.books.put(book);
/// });
/// ```
@collection
class Book {
  // 类实现
}
```

### 1.3 函数注释
每个公开函数必须有注释，说明函数的功能、参数、返回值和异常情况。

```dart
/// 启动TTS语音朗读
/// 
/// 从当前阅读位置开始合成并播放语音，自动处理段落衔接
/// 
/// 参数：
/// - [text] 需要朗读的文本内容
/// - [startPosition] 起始字符索引（可选）
/// 
/// 返回值：
/// - Future<void> 播放开始后完成
/// 
/// 异常：
/// - [TtsException] 当语音合成服务不可用时抛出
Future<void> startSpeaking(String text, {int? startPosition}) async {
  // 函数实现
}
```

### 1.4 变量注释
重要的成员变量必须有注释，尤其是状态变量（GetX Observables）。

```dart
/// 当前阅读进度（百分比 0.0 - 1.0）
final RxDouble progress = 0.0.obs;

/// WebDAV 同步状态
/// 
/// true: 正在同步中
/// false: 同步空闲
final RxBool isSyncing = false.obs;
```

### 1.5 Todo注释
使用TODO注释标记待完成的功能或需要改进的地方。

```dart
// TODO: 优化 PDF 大文件加载性能，考虑使用 Isolate
// TODO: 支持 EPUB 格式的图片渲染
// TODO: 添加 TTS 朗读时的句子高亮功能
```

## 二、Todo管理规范 (使用 TodoWrite 工具)

### 2.1 Todo创建时机
在开始实现任何功能之前，必须先创建Todo任务。

### 2.2 Todo任务格式
- **id**: 唯一标识符
- **content**: 任务描述（清晰、具体）
- **status**: pending / in_progress / completed
- **priority**: high / medium / low

**示例：**
```json
{
  "id": "tts_feature_01",
  "content": "集成 Edge TTS 服务，实现基础文本转语音",
  "status": "pending",
  "priority": "high"
}
```

### 2.3 任务粒度
- 避免过于笼统的任务（如"做完阅读器"）
- 拆分为可执行的单元（如"实现翻页动画"、"保存阅读进度"、"解析PDF目录"）

## 三、代码规范

### 3.1 命名规范

#### 3.1.1 文件与目录
- 使用小写字母和下划线 (`snake_case`)
- 示例：`reader_controller.dart`, `webdav_service.dart`, `book_model.dart`

#### 3.1.2 类名
- 使用大驼峰命名法 (`PascalCase`)
- 示例：`ReaderController`, `WebDavService`, `PdfPageRender`

#### 3.1.3 变量与函数
- 使用小驼峰命名法 (`camelCase`)
- 示例：`currentPage`, `fetchBooks()`, `syncToCloud()`

### 3.2 代码组织 (GetX Pattern)

本项目采用 GetX 架构，目录结构如下：

```
lib/
├── main.dart                      # 应用入口
├── app/
│   ├── data/                      # 数据层
│   │   ├── models/                # 数据模型 (Isar Entities)
│   │   │   ├── book.dart
│   │   │   └── category.dart
│   │   └── providers/             # API/Database Providers
│   ├── modules/                   # 业务模块 (GetX Pages)
│   │   ├── bookshelf/             # 书架模块
│   │   │   ├── controllers/
│   │   │   └── views/
│   │   ├── reader/                # 阅读器模块
│   │   │   ├── controllers/
│   │   │   └── views/
│   │   └── settings/              # 设置模块
│   ├── services/                  # 全局服务 (GetxService)
│   │   ├── database_service.dart  # Isar 数据库封装
│   │   ├── tts_service.dart       # TTS 语音服务
│   │   ├── webdav_service.dart    # WebDAV 同步服务
│   │   └── pdf_service.dart       # PDF 解析服务
│   ├── routes/                    # 路由定义
│   └── utils/                     # 工具类
│       ├── file_helper.dart
│       └── text_cleaner.dart
└── generated/                     # 代码生成目录 (Isar, Assets)
```

### 3.3 导入顺序
1. Dart 核心库 (`dart:`)
2. Flutter 框架 (`package:flutter/`)
3. 第三方库 (`package:get/`, `package:isar/` 等)
4. 项目内部文件 (相对路径或 `package:pdf_reader/`)

```dart
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:isar/isar.dart';

import '../../data/models/book.dart';
import '../../services/tts_service.dart';
```

## 四、Flutter & GetX 开发规范

### 4.1 状态管理 (GetX)
- **Controller**: 业务逻辑必须放入 Controller，禁止在 View 中写复杂逻辑。
- **Reactive**: 优先使用 `.obs` 响应式变量和 `Obx(() => ...)` 局部刷新。
- **Memory**: 对于大对象或不需要响应式的状态，使用普通变量，配合 `update()` (GetBuilder) 使用，但本项目优先推荐响应式编程。
- **Dependency Injection**: 使用 `Get.put()` 或 `Get.lazyPut()` 进行依赖注入，推荐在 Binding 中统一管理。

**示例：**
```dart
class ReaderController extends GetxController {
  // 状态定义
  final isPlaying = false.obs;
  
  // 方法定义
  void togglePlay() {
    isPlaying.value = !isPlaying.value;
  }
}

// View 中使用
Obx(() => Icon(
  controller.isPlaying.value ? Icons.pause : Icons.play_arrow
))
```

### 4.2 数据库 (Isar)
- 所有数据库操作应封装在 `DatabaseService` 或特定的 Repository 中。
- 必须使用异步事务 `isar.writeTxn(() async { ... })` 进行写入。
- 记得在模型修改后运行 `flutter pub run build_runner build` 更新生成文件。

### 4.3 异步编程
- 避免阻塞 UI 线程，耗时操作（如 PDF 解析、文件 I/O）应考虑放入 Isolate 或确保使用异步 API。
- 使用 `async/await` 替代 `.then()` 链式调用，保持代码可读性。

## 五、Git 提交规范

### 5.1 格式
`<type>(<scope>): <subject>`

### 5.2 Type 类型
- **feat**: 新功能 (WebDAV, TTS, EPUB支持)
- **fix**: 修复 Bug
- **refactor**: 代码重构 (不改变逻辑)
- **style**: 格式调整 (空格, 换行)
- **docs**: 文档更新
- **chore**: 构建脚本, 依赖更新

**示例：**
```
feat(reader): 增加 TTS 语速调节功能
fix(webdav): 修复同步时文件名中文乱码问题
chore(deps): 升级 isar 到 v3.1.0
```

## 六、其他注意事项
1. **换行符**: 统一使用 **LF** (\n)，禁止 CRLF。
2. **敏感信息**: 禁止在 Log 中打印用户密码、Token 等敏感信息。
3. **文件清理**: 禁止提交 `.DS_Store`、`build/` 等临时文件。
